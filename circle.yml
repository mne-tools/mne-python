machine:
  python:
    version: 2.7.10

dependencies:
  cache_directories:
    - ../examples/

  pre:
    - >
      if [ -n "${RUN_NIGHTLY_BUILD}" ]; then
        cd .. && sudo mkdir examples
        sudo pip install --upgrade pip
        sudo pip install traitlets pexpect pickleshare simplegeneric
        wget https://pypi.python.org/packages/source/i/ipython/ipython-4.1.1.tar.gz && tar -xzf ipython-4.1.1.tar.gz && cd ipython-4.1.1 && sudo python setup.py install
        sudo pip install sphinx==1.2.3 pygraphviz matplotlib Pillow neo scipy numpy
        git clone https://github.com/sphinx-gallery/sphinx-gallery.git && cd sphinx-gallery && sudo pip install -r requirements.txt && sudo python setup.py develop
        sudo pip install sphinx_bootstrap_theme
        sudo pip install numpy --upgrade
        sudo apt-get install libvtk5-dev python-vtk python-configobj
        sudo pip install mayavi
        sudo pip install pysurfer
        sudo pip install nilearn
        /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1400x900x24 -ac +extension GLX +render -noreset
        sudo pip install scikit-learn
        cd /home/ubuntu/mne-python && sudo python setup.py install
        sudo make sample_data
        sudo make testing_data
        sudo make spm_data
        sudo make somato_data
        cd ..
        sudo chmod -R 777 .mne
        sudo chmod -R 777 examples
        cd .mne && sudo chmod 777 mne-python.json && echo '{"MNE_DATASETS_BRAINSTORM_PATH":"/home/ubuntu/examples","MNE_DATASETS_EEGBCI_PATH":"/home/ubuntu/examples","MNE_DATASETS_MEGSIM_PATH":"/home/ubuntu/examples","MNE_DATASETS_SAMPLE_PATH":"/home/ubuntu/examples","MNE_DATASETS_SOMATO_PATH":"/home/ubuntu/examples","MNE_DATASETS_SPM_FACE_PATH":"/home/ubuntu/examples","MNE_DATASETS_TESTING_PATH":"/home/ubuntu/examples"}' > mne-python.json
        if [[ ! -e ../examples/MNE-brainstorm-data ]]; then cd .. && sudo chmod 777 examples && cd examples && mkdir MNE-brainstorm-data && cd MNE-brainstorm-data && wget https://copy.com/ZTHXXFcuIZycvRoA/brainstorm/bst_raw.tar.bz2 && tar xvf bst_raw.tar.bz2; fi
      fi

  override:
    - cd

test:
  override:
    # Some examples take longer than 10 minutes to run.
    - if [ -n "${RUN_NIGHTLY_BUILD}" ]; then case $CIRCLE_NODE_INDEX in 0) cd doc && make html_dev-pattern PATTERN='/io/plot_\|/inverse/plot_\|/visualization/plot_' ;; 1) cd doc && make html_dev-pattern PATTERN='/preprocessing/plot_\|/datasets/plot_' ;; 2) cd doc && make html_dev-pattern PATTERN='/tutorials/plot_\|/examples/plot_' ;; 3) cd doc && make html_dev-pattern PATTERN='/connectivity/plot_\|/realtime/plot_\|/forward/plot_\|/stats/plot_\|/time_frequency/plot_\|/simulation/plot_\|/decoding/plot_' ;; esac fi:
        parallel: true
        timeout: 1500

general:
  artifacts:
    - "doc/_build/html"
