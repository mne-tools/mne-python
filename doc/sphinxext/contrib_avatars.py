from io import StringIO

from selenium import webdriver
from selenium.webdriver.common.by import By

TEMPLATE = """
<html>
    <head>
        <script src="../_static/js/contrib-avatars.js"></script>
    </head>
    <body>
    </body>
</html>
"""


def generate_contrib_avatars(app):
    """Render a template webpage with avatars generated by JS and a GitHub API call."""
    options = webdriver.ChromeOptions()
    options.add_argument("--headless=new")
    driver = webdriver.Chrome(options=options)
    with StringIO(TEMPLATE) as f:
        driver.get(f)
        driver.implicitly_wait(5)
        body = driver.find_element(by=By.TAG_NAME, value="body").get_attribute(
            "innerHTML"
        )
        with open("../_templates/avatars.html", "w") as fid:
            fid.write(body)
        driver.quit()


def setup(app):
    """Set up the Sphinx app."""
    app.connect("config-inited", generate_contrib_avatars)
    return
