trigger:
  # start a new build for every push
  batch: false
  branches:
    include:
      - 'main'
      - 'maint/*'
pr:
  branches:
    include:
      - '*'  # must quote since "*" is a YAML reserved character; we want a string


stages:

  - stage: Check
    jobs:
      - job: Skip
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          DECODE_PERCENTS: 'false'
          RET: 'true'
          BUILD_REASON: $(Build.Reason)
        steps:
          - bash: |
              git_log=`git log --format=oneline -n 1 --skip=1`
              echo "##vso[task.setvariable variable=log]$git_log"
          - bash: echo "##vso[task.setvariable variable=RET]false"
            condition: and(eq(variables.BUILD_REASON, 'PullRequest'), or(contains(variables.log, '[skip azp]'), contains(variables.log, '[azp skip]'), contains(variables.log, '[skip ci]'), contains(variables.log, '[ci skip]')))
          - bash: echo "##vso[task.setvariable variable=start_main;isOutput=true]$RET"
            name: result

  - stage: Style
    variables:
      AZURE_CI: 'true'
    jobs:
      - job: All
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          PYTHON_VERSION: '3.11'
          PYTHON_ARCH: 'x64'
        steps:
          - bash: echo $(COMMIT_MSG)
          - task: UsePythonVersion@0
            inputs:
              versionSpec: $(PYTHON_VERSION)
              architecture: $(PYTHON_ARCH)
              addToPath: true
            displayName: 'Get Python'
          - bash: |
              set -eo pipefail
              python -m pip install --progress-bar off --upgrade pip build
              python -m pip install --progress-bar off -ve .[hdf5,test]
              python -m pip uninstall -yq pytest-qt  # don't want to set up display, etc. for this
              pre-commit install --install-hooks
            displayName: Install dependencies
          - bash: |
              make pre-commit
            displayName: make pre-commit
            condition: always()
          - bash: |
              make nesting
            displayName: make nesting
            condition: always()
          - bash: |
              make check-readme
            displayName: make check-readme
            condition: always()

  - stage: Test
    condition: and(succeeded(), eq(dependencies.Check.outputs['Skip.result.start_main'], 'true'))
    dependsOn: ['Style', 'Check']
    variables:
      AZURE_CI: 'true'
    jobs:

      - job: Windows
        pool:
          vmImage: 'windows-latest'
        variables:
          MNE_LOGGING_LEVEL: 'warning'
          MNE_FORCE_SERIAL: 'true'
          OPENBLAS_NUM_THREADS: 2
          OMP_DYNAMIC: 'false'
          PYTHONUNBUFFERED: 1
          PYTHONIOENCODING: 'utf-8'
          AZURE_CI_WINDOWS: 'true'
          PYTHON_ARCH: 'x64'
        timeoutInMinutes: 70
        strategy:
          maxParallel: 4
          matrix:
            3.11 pip pre:
              TEST_MODE: 'pip-pre'
              PYTHON_VERSION: '3.11'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: $(PYTHON_VERSION)
              architecture: $(PYTHON_ARCH)
              addToPath: true
            displayName: 'Get Python'
          - bash: |
              set -eo pipefail
              git clone --depth 1 https://github.com/pyvista/gl-ci-helpers.git
              powershell gl-ci-helpers/appveyor/install_opengl.ps1
            displayName: Install OpenGL
          - bash: ./tools/azure_dependencies.sh
            displayName: Install dependencies with pip
          - script: pip install -e .
            displayName: 'Install MNE-Python dev'
          - script: mne sys_info -pd
            displayName: 'Print config'
          - script: python -c "import numpy; numpy.show_config()"
            displayName: Print NumPy config
          - bash: source tools/get_testing_version.sh
            displayName: 'Get testing version'
          - task: Cache@2
            inputs:
              key: $(testing_version)
              path: C:\Users\VssAdministrator\mne_data
            displayName: 'Cache testing data'
          - script: python -c "import mne; mne.datasets.testing.data_path(verbose=True)"
            displayName: 'Get test data'
          - script: pytest -m "not (slowtest or pgtest)" --tb=short --cov=mne --cov-report=xml --cov-report=html -vv mne/preprocessing/tests/test_lof.py
            displayName: 'Run tests'
          - bash: bash <(curl -s https://codecov.io/bash)
            displayName: 'Codecov'
            condition: succeededOrFailed()
          - task: PublishTestResults@2
            inputs:
              testResultsFiles: '**/junit-*.xml'
              testRunTitle: 'Publish test results for $(Agent.JobName) $(TEST_MODE) $(PYTHON_VERSION)'
              failTaskOnFailedTests: true
            condition: succeededOrFailed()
          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: Cobertura
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'
