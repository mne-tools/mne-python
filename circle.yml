machine:
  python:
    version: 2.7.10

dependencies:
  cache_directories:
    - ../examples/

  pre:
    - sudo pip install --upgrade pip
    - sudo pip install traitlets pexpect pickleshare simplegeneric
    - cd .. && wget https://pypi.python.org/packages/source/i/ipython/ipython-4.1.1.tar.gz && tar -xzf ipython-4.1.1.tar.gz && cd ipython-4.1.1 && sudo python setup.py install
    - sudo pip install sphinx==1.2.3 pygraphviz matplotlib Pillow neo scipy numpy
    - cd .. && git clone https://github.com/sphinx-gallery/sphinx-gallery.git && cd sphinx-gallery && sudo pip install -r requirements.txt && sudo python setup.py develop
    - sudo pip install sphinx_bootstrap_theme
    - sudo pip install numpy --upgrade
    - sudo apt-get install libvtk5-dev python-vtk python-configobj
    - sudo pip install mayavi
    - sudo pip install pysurfer
    - /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1400x900x24 -ac +extension GLX +render -noreset
    - sudo pip install scikit-learn
    - sudo python setup.py install
    - sudo make sample_data
    - sudo make testing_data
    - sudo make spm_data
    - sudo make somato_data
    # Add a conf file manually to avoid queries in the middle of the build.
    - cd .. && cd .mne && sudo chmod 777 mne-python.json && echo '{"MNE_DATASETS_BRAINSTORM_PATH":"/home/ubuntu/examples","MNE_DATASETS_EEGBCI_PATH":"/home/ubuntu/examples","MNE_DATASETS_MEGSIM_PATH":"/home/ubuntu/examples","MNE_DATASETS_SAMPLE_PATH":"/home/ubuntu/examples","MNE_DATASETS_SOMATO_PATH":"/home/ubuntu/examples","MNE_DATASETS_SPM_FACE_PATH":"/home/ubuntu/examples","MNE_DATASETS_TESTING_PATH":"/home/ubuntu/examples"}' > mne-python.json
    - if [[ ! -e ../examples/MNE-brainstorm-data ]]; then cd .. && sudo chmod 777 examples && cd examples && mkdir MNE-brainstorm-data && cd MNE-brainstorm-data && wget https://copy.com/ZTHXXFcuIZycvRoA/brainstorm/bst_raw.tar.bz2 && tar xvf bst_raw.tar.bz2; fi

  override:
    - cd .. && sudo chmod -R 777 .mne
    - cd .. && sudo chmod -R 777 examples

test:
  override:
    # Some examples take longer than 10 minutes to run.
    - case $CIRCLE_NODE_INDEX in 0) cd doc && make html_dev-pattern PATTERN='/io/plot_\|/inverse/plot_\|/decoding/plot_' ;; 1) cd doc && make html_dev-pattern PATTERN='/preprocessing/plot_\|/visualization/plot_\|/datasets/plot_' ;; 2) cd doc && make html_dev-pattern PATTERN='/time_frequency/plot_\|/stats/plot_\|/simulation/plot_' ;; 3)cd doc && make html_dev-pattern PATTERN='/connectivity/plot_\|/realtime/plot_\|/forward/plot_' ;; esac:
        parallel: true
        timeout: 2500

general:
  artifacts:
    - "doc/_build/html"
